pipeline {
  agent any

  environment {
    APP_NAME           = "helloapp"
    ECR_URI            = "492422659405.dkr.ecr.ap-south-1.amazonaws.com/tf-jenkins-demo-repo"
    EC2_IP             = "13.233.132.134"
    AWS_DEFAULT_REGION = "ap-south-1"
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build Docker') {
      steps {
        sh 'docker build -t $APP_NAME:ci ./app'
      }
    }

    stage('Unit Test (inside image)') {
      steps {
        // server.py is in the image WORKDIR /app
        sh 'docker run --rm $APP_NAME:ci python -m py_compile server.py'
      }
    }

    stage('Login to ECR and Push') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']]) {
          script {
            def ecrRegistry = ECR_URI.split('/')[0]
            sh """
              aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ecrRegistry}
              docker tag ${APP_NAME}:ci ${ECR_URI}:latest
              docker push ${ECR_URI}:latest
            """
          }
        }
      }
    }

    stage('Deploy to EC2') {
      steps {
        script {
          def ecrRegistry = ECR_URI.split('/')[0]
          sshagent(credentials: ['ec2-ssh']) {
            sh """
              ssh -o StrictHostKeyChecking=no ubuntu@${EC2_IP} 'set -eux
                # make sure docker is up
                sudo systemctl enable --now docker || true
    
                # login to ECR and pull
                aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | sudo docker login -u AWS --password-stdin ${ecrRegistry}
                sudo docker pull ${ECR_URI}:latest
    
                # restart container
                sudo docker rm -f ${APP_NAME} || true
                sudo docker run -d -p 8080:8080 --restart unless-stopped --name ${APP_NAME} ${ECR_URI}:latest
              '
            """
          }
        }
      }
    }

  post {
    success {
      echo "Deployed successfully to http://${EC2_IP}:8080"
    }
  }
}
